{
  "$schema": "https://json-schema.org/draft-07/schema#",
  "$id": "exploit-hunt-review.schema.json",
  "title": "Exploit Hunt Review",
  "description": "Schema for Stage 4 blind exploit hunt review output",
  "type": "object",
  "required": [
    "id",
    "reviewer",
    "model",
    "bundle",
    "blindness_verified",
    "decision",
    "hypotheses_attempted",
    "invariant_coverage",
    "reviewed_at"
  ],
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^exploit-hunt-review-\\d{8}-\\d{6}$",
      "description": "Unique review ID in format exploit-hunt-review-YYYYMMDD-HHMMSS"
    },
    "reviewer": {
      "type": "string",
      "const": "exploit-hunter",
      "description": "Agent that performed the review"
    },
    "model": {
      "type": "string",
      "enum": ["opus", "sonnet"],
      "description": "Model used for review"
    },
    "bundle": {
      "type": "string",
      "const": "bundle-stage4",
      "description": "Bundle reviewed (must be stage 4)"
    },
    "blindness_verified": {
      "type": "boolean",
      "const": true,
      "description": "Confirms reviewer did not see spec prose"
    },
    "decision": {
      "type": "string",
      "enum": ["APPROVED", "NEEDS_CHANGES", "NEEDS_CLARIFICATION"],
      "description": "Review decision"
    },
    "hypotheses_attempted": {
      "type": "integer",
      "minimum": 1,
      "description": "Number of exploit hypotheses attempted (min 1 required)"
    },
    "hypotheses": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["name", "target", "attack_vector", "result"],
        "properties": {
          "name": {
            "type": "string",
            "description": "Name of the hypothesis"
          },
          "target": {
            "type": "string",
            "description": "Function or flow targeted"
          },
          "attack_vector": {
            "type": "string",
            "description": "Description of the attack"
          },
          "result": {
            "type": "string",
            "enum": ["CONFIRMED", "PARTIAL", "REFUTED"],
            "description": "Result of testing this hypothesis"
          },
          "details": {
            "type": "string",
            "description": "Analysis details"
          }
        }
      }
    },
    "exploits_confirmed": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["id", "severity", "title", "affected"],
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^EH-\\d+$",
            "description": "Exploit ID in format EH-N"
          },
          "severity": {
            "type": "string",
            "enum": ["HIGH", "MED", "LOW"],
            "description": "Severity level"
          },
          "title": {
            "type": "string",
            "description": "Brief title"
          },
          "affected": {
            "type": "string",
            "description": "Affected contract::function"
          },
          "description": {
            "type": "string",
            "description": "Detailed description"
          },
          "reproduction_steps": {
            "type": "array",
            "items": { "type": "string" },
            "description": "Steps to reproduce"
          },
          "expected_fix": {
            "type": "string",
            "description": "What needs to change"
          },
          "regression_test_required": {
            "type": "string",
            "description": "Test file path"
          }
        }
      }
    },
    "invariant_coverage": {
      "type": "object",
      "required": ["total", "covered", "unclear", "violated"],
      "properties": {
        "total": {
          "type": "integer",
          "minimum": 0,
          "description": "Total invariants checked"
        },
        "covered": {
          "type": "integer",
          "minimum": 0,
          "description": "Invariants clearly enforced"
        },
        "unclear": {
          "type": "integer",
          "minimum": 0,
          "description": "Invariants with unclear enforcement"
        },
        "violated": {
          "type": "integer",
          "minimum": 0,
          "description": "Invariants found violated"
        },
        "details": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["invariant_id", "status"],
            "properties": {
              "invariant_id": {
                "type": "string",
                "pattern": "^(IC|IS|IA|IT|IB)-\\d+$"
              },
              "expression": { "type": "string" },
              "status": {
                "type": "string",
                "enum": ["COVERED", "UNCLEAR", "VIOLATED"]
              },
              "evidence": { "type": "string" }
            }
          }
        }
      }
    },
    "required_tests": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["invariant", "test", "type"],
        "properties": {
          "invariant": {
            "type": "string",
            "pattern": "^(IC|IS|IA|IT|IB)-\\d+$"
          },
          "test": {
            "type": "string",
            "description": "Test name"
          },
          "type": {
            "type": "string",
            "enum": ["Unit", "Fuzz", "Invariant", "Integration"]
          },
          "description": { "type": "string" }
        }
      }
    },
    "economic_risks": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["type", "severity"],
        "properties": {
          "type": {
            "type": "string",
            "enum": ["sandwich", "flash_loan", "front_running", "price_manipulation", "mev", "other"]
          },
          "severity": {
            "type": "string",
            "enum": ["HIGH", "MED", "LOW"]
          },
          "description": { "type": "string" },
          "mitigation_needed": { "type": "boolean" },
          "mitigation_suggestion": { "type": "string" }
        }
      }
    },
    "dos_risks": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["type", "severity"],
        "properties": {
          "type": {
            "type": "string",
            "enum": ["unbounded_loop", "state_bloat", "block_gas_limit", "griefing_revert", "other"]
          },
          "severity": {
            "type": "string",
            "enum": ["HIGH", "MED", "LOW"]
          },
          "description": { "type": "string" },
          "mitigation_needed": { "type": "boolean" },
          "mitigation_suggestion": { "type": "string" }
        }
      }
    },
    "notes": { "type": "string" },
    "reviewed_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO8601 timestamp"
    }
  }
}
