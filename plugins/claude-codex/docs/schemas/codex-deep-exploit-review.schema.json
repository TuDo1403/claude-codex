{
  "$schema": "https://json-schema.org/draft-07/schema#",
  "$id": "codex-deep-exploit-review.schema.json",
  "title": "Codex Deep Exploit Review",
  "description": "Schema for Stage 4B Codex deep exploit hunt with required refutation evidence (adversarial mode)",
  "type": "object",
  "required": [
    "id",
    "reviewer",
    "model",
    "bundle",
    "blindness_verified",
    "opus_isolation_verified",
    "confirmed_exploits",
    "refuted_hypotheses",
    "false_positives_invalidated",
    "invariant_coverage",
    "generated_at"
  ],
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^codex-deep-exploit-review-\\d{8}-\\d{6}$",
      "description": "Unique review ID in format codex-deep-exploit-review-YYYYMMDD-HHMMSS"
    },
    "reviewer": {
      "type": "string",
      "const": "codex-deep-exploit-hunter",
      "description": "Agent that performed the review"
    },
    "model": {
      "type": "string",
      "const": "codex",
      "description": "Model used (must be codex)"
    },
    "bundle": {
      "type": "string",
      "const": "bundle-stage4b",
      "description": "Bundle reviewed (must be stage 4b)"
    },
    "blindness_verified": {
      "type": "boolean",
      "const": true,
      "description": "Confirms reviewer did not see spec prose"
    },
    "opus_isolation_verified": {
      "type": "boolean",
      "const": true,
      "description": "Confirms reviewer did not see Opus attack plan"
    },
    "confirmed_exploits": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["id", "severity", "type", "title", "affected", "invariants_violated"],
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^CEH-\\d+$",
            "description": "Codex Exploit Hunt ID"
          },
          "severity": {
            "type": "string",
            "enum": ["HIGH", "MED", "LOW"],
            "description": "Severity level"
          },
          "type": {
            "type": "string",
            "enum": ["cross_module", "state_machine", "reentrancy", "access_control", "arithmetic", "economic", "dos", "other"],
            "description": "Exploit type"
          },
          "title": {
            "type": "string",
            "description": "Brief title"
          },
          "affected": {
            "type": "array",
            "items": { "type": "string" },
            "description": "Affected contracts"
          },
          "invariants_violated": {
            "type": "array",
            "items": {
              "type": "string",
              "pattern": "^(IC|IS|IA|IT|IB)-\\d+$"
            },
            "description": "Invariants violated"
          },
          "deep_analysis": {
            "type": "string",
            "description": "Detailed reasoning"
          },
          "attack_path": {
            "type": "array",
            "items": { "type": "string" },
            "description": "Step-by-step attack path"
          },
          "preconditions": {
            "type": "array",
            "items": { "type": "string" },
            "description": "Required preconditions"
          },
          "estimated_impact": {
            "type": "string",
            "description": "Estimated damage/impact"
          },
          "proof_of_concept": {
            "type": "string",
            "description": "PoC test function"
          },
          "required_fix": {
            "type": "string",
            "description": "Suggested fix"
          },
          "regression_test": {
            "type": "string",
            "description": "Regression test file path"
          }
        }
      }
    },
    "refuted_hypotheses": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["id", "hypothesis", "investigation_steps", "why_it_fails", "guard_code_ref"],
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^REF-\\d+$",
            "description": "Refutation ID"
          },
          "hypothesis": {
            "type": "string",
            "description": "What was hypothesized"
          },
          "investigation_steps": {
            "type": "array",
            "minItems": 1,
            "items": { "type": "string" },
            "description": "Steps taken to investigate"
          },
          "why_it_fails": {
            "type": "string",
            "description": "Evidence-based explanation of why attack fails"
          },
          "guard_code_ref": {
            "type": "string",
            "description": "Code reference showing the guard (File:Line)"
          }
        }
      },
      "description": "Hypotheses that were attempted but proven non-viable (min 1 required)"
    },
    "false_positives_invalidated": {
      "type": "array",
      "minItems": 3,
      "items": {
        "type": "object",
        "required": ["id", "concern", "evidence", "code_ref"],
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^FP-\\d+$",
            "description": "False positive ID"
          },
          "concern": {
            "type": "string",
            "description": "The common security concern"
          },
          "evidence": {
            "type": "string",
            "description": "Evidence showing why it's not a real issue"
          },
          "code_ref": {
            "type": "string",
            "description": "Code reference showing protection"
          }
        }
      },
      "description": "Common concerns proven to be false positives (min 3 required)"
    },
    "cross_module_analysis": {
      "type": "object",
      "properties": {
        "modules_analyzed": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Modules analyzed"
        },
        "interactions_checked": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of cross-module interactions checked"
        },
        "issues_found": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of cross-module issues found"
        }
      }
    },
    "invariant_coverage": {
      "type": "object",
      "required": ["total", "verified", "partial", "unverified"],
      "properties": {
        "total": {
          "type": "integer",
          "minimum": 0,
          "description": "Total invariants"
        },
        "verified": {
          "type": "integer",
          "minimum": 0,
          "description": "Invariants fully verified"
        },
        "partial": {
          "type": "integer",
          "minimum": 0,
          "description": "Invariants partially verified"
        },
        "unverified": {
          "type": "integer",
          "minimum": 0,
          "description": "Invariants not verified"
        },
        "details": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "invariant_id": {
                "type": "string",
                "pattern": "^(IC|IS|IA|IT|IB)-\\d+$"
              },
              "status": {
                "type": "string",
                "enum": ["VERIFIED", "PARTIAL", "UNVERIFIED"]
              },
              "evidence": { "type": "string" }
            }
          }
        }
      }
    },
    "open_issues_for_dispute": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Issues that need resolution in Stage 4C"
    },
    "confidence": {
      "type": "object",
      "properties": {
        "reentrancy": {
          "type": "string",
          "enum": ["high", "medium", "low"]
        },
        "access_control": {
          "type": "string",
          "enum": ["high", "medium", "low"]
        },
        "economic": {
          "type": "string",
          "enum": ["high", "medium", "low"]
        },
        "dos": {
          "type": "string",
          "enum": ["high", "medium", "low"]
        }
      },
      "description": "Confidence levels by category"
    },
    "generated_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO8601 timestamp"
    }
  },
  "additionalProperties": false
}
